# 调度器日志轮转实现总结

## 实现内容

为调度器检查日志（`run/logs/scheduler_check.log`）实现了自动轮转和大小控制功能，与主应用日志（`app.log`）保持一致的行为。

## 代码修改

### 1. 配置模型（`internal/models/models.go`）

更新了配置字段的注释：
```go
MaxLogSizeMB int `yaml:"max_log_size_mb" json:"max_log_size_mb"` 
// 日志文件最大大小（MB，0表示不限制，应用于app.log和scheduler_check.log）
```

**设计理念**：主应用日志和调度器检查日志共用同一个配置参数，简化配置管理。

### 2. 默认配置（`config/config.go`）

无需单独设置调度器日志大小，直接使用 `MaxLogSizeMB` 配置：
```go
// 两种日志（app.log 和 scheduler_check.log）共用此配置
cfg.MaxLogSizeMB  // 默认值可在配置文件中设置
```

### 3. 调度器实现（`internal/scheduler/scheduler.go`）

#### 修改 NewScheduler 函数签名
```go
func NewScheduler(runDir string, maxLogSizeMB int) *Scheduler
```

#### 添加日志轮转逻辑
在创建日志文件前检查并轮转：
```go
if maxLogSizeMB > 0 {
    if err := rotateSchedulerLogIfNeeded(checkLogPath, maxLogSizeMB); err != nil {
        log.Printf("Warning: failed to rotate scheduler check log: %v", err)
    }
}
```

#### 新增轮转函数
```go
func rotateSchedulerLogIfNeeded(logFile string, maxSizeMB int) error
```

实现逻辑：
1. 检查文件是否存在
2. 计算文件大小（字节转 MB）
3. 如果超过限制，执行轮转：
   - 删除旧的 `.old` 备份
   - 重命名当前文件为 `.old`
   - 记录轮转日志

### 4. 主函数调用（`main.go`）

传入通用的日志大小配置：
```go
sched := scheduler.NewScheduler(runDir, cfg.MaxLogSizeMB)
```

**优点**：统一管理所有日志文件的大小限制，简化配置。

### 5. 测试文件（`internal/scheduler/scheduler_test.go`）

修复测试中的调用，传入 0 表示不限制：
```go
sched := NewScheduler(tmpDir, 0) // 0 表示不限制日志大小
```

### 6. 配置文件（`config.yaml`）

简化为单一配置项：
```yaml
# 此配置同时应用于主应用日志和调度器检查日志
max_log_size_mb: 10
```

### 7. 文档更新（`docs/调度器检查日志说明.md`）

添加了完整的日志轮转说明，包括：
- 配置方法
- 轮转机制
- 日志大小估算表
- 最佳实践建议

## 日志轮转机制

### 触发时机
- **仅在服务启动时**检查日志文件大小
- 如果超过配置的限制，执行轮转后再创建日志记录器

### 轮转策略
- 保留 1 个备份文件（`.old`）
- 新备份会覆盖旧备份
- 简单高效，适合调试日志

### 与 app.log 的对比

| 特性 | app.log | scheduler_check.log |
|------|---------|---------------------|
| 轮转时机 | 启动时 | 启动时 |
| 配置参数 | `max_log_size_mb` | `max_log_size_mb` (共用) |
| 轮转函数 | `rotateLogIfNeeded()` | `rotateSchedulerLogIfNeeded()` |
| 备份策略 | `.old` 单一备份 | `.old` 单一备份 |
| 默认大小 | 配置文件设置 | 配置文件设置（共用） |

## 日志大小估算

基于实际使用场景的估算：

**假设条件：**
- 每分钟检查一次
- 每次检查记录 4 行（开始 + 2个任务 + 结束）
- 每行约 120 字节

**存储容量：**
```
每分钟：4 行 × 120 字节 = 480 字节
每小时：480 字节 × 60 = 28 KB
每天：28 KB × 24 = 675 KB
每周：675 KB × 7 = 4.6 MB
每月：675 KB × 30 = 20 MB
```

**建议配置：**
- **10 MB**：保留约 2 周的记录（推荐用于调试）
- **5 MB**：保留约 1 周的记录（适合生产环境）
- **20 MB**：保留约 1 个月的记录（适合长期分析）

## 使用示例

### 配置文件设置

```yaml
# config.yaml

# 日志文件最大大小（单位：MB）
# 此配置同时应用于主应用日志（app.log）和调度器检查日志（scheduler_check.log）
max_log_size_mb: 10  # 保留约2周记录
```

### 查看轮转记录

轮转操作会在主应用日志中记录：

```bash
tail -20 run/logs/app.log | grep "rotated"
```

示例输出：
```
2026/01/23 12:00:00 Scheduler check log file rotated: run/logs/scheduler_check.log (12.50 MB) -> run/logs/scheduler_check.log.old
```

### 查看当前日志文件大小

```bash
ls -lh run/logs/scheduler_check.log*
```

示例输出：
```
-rw-r--r--  1 user  staff   1.2M Jan 23 12:00 scheduler_check.log
-rw-r--r--  1 user  staff    12M Jan 23 11:59 scheduler_check.log.old
```

## 注意事项

1. **轮转时机**：只在服务启动时检查，运行期间不会自动轮转
2. **备份数量**：只保留一个 `.old` 备份文件
3. **配置变更**：修改配置后需要重启服务才能生效
4. **磁盘空间**：最大占用空间约为配置值的 2 倍（当前 + 备份）
5. **禁用轮转**：设置为 0 表示不限制日志大小

## 最佳实践

1. **开发环境**：设置为 10-20 MB，保留足够的调试信息
2. **生产环境**：设置为 5-10 MB，平衡存储和调试需求
3. **定期检查**：定期查看日志文件大小，根据实际情况调整配置
4. **备份重要日志**：如果需要长期保存，手动备份 `.old` 文件

## 相关文件

- `/internal/models/models.go` - 配置模型定义
- `/config/config.go` - 默认配置
- `/internal/scheduler/scheduler.go` - 调度器实现
- `/main.go` - 主函数调用
- `/config.yaml` - 配置文件示例
- `/docs/调度器检查日志说明.md` - 详细文档
