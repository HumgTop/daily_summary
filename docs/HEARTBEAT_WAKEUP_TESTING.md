# å¿ƒè·³å”¤é†’æœºåˆ¶æµ‹è¯•æŒ‡å—

## åŠŸèƒ½è¯´æ˜

å¿ƒè·³å”¤é†’æœºåˆ¶é€šè¿‡å®šæœŸæ£€æµ‹æ—¶é—´é—´éš”æ¥åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦ä»ç¡çœ ä¸­å”¤é†’ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°å”¤é†’æ—¶è‡ªåŠ¨é‡ç½®å®šæ—¶å™¨ã€‚

**æ ¸å¿ƒå‚æ•°**ï¼š
- **å¿ƒè·³é—´éš”**ï¼š10 ç§’
- **å”¤é†’é˜ˆå€¼**ï¼š20 ç§’ï¼ˆä¸¤æ¬¡å¿ƒè·³é—´éš”è¶…è¿‡ 20 ç§’åˆ¤å®šä¸ºå”¤é†’ï¼‰

**å·¥ä½œåŸç†**ï¼š
```
æ­£å¸¸æƒ…å†µï¼š
10:00:00 å¿ƒè·³ â†’ 10:00:10 å¿ƒè·³ â†’ 10:00:20 å¿ƒè·³ï¼ˆé—´éš” 10sï¼Œæ­£å¸¸ï¼‰

ç¡çœ åœºæ™¯ï¼š
10:00:00 å¿ƒè·³ â†’ [Mac ç¡çœ  2 åˆ†é’Ÿ] â†’ 10:02:10 å¿ƒè·³
                                      â†‘
                                é—´éš” 130s > 20s é˜ˆå€¼
                                æ£€æµ‹åˆ°å”¤é†’ï¼è§¦å‘é‡ç½®
```

## å®æ–½çš„æ”¹åŠ¨

### 1. æ–‡ä»¶ä¿®æ”¹

| æ–‡ä»¶ | æ”¹åŠ¨å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| `internal/scheduler/scheduler.go` | æ·»åŠ å¿ƒè·³ç›‘æ§å­—æ®µå’Œæ–¹æ³• | +80 |
| `internal/scheduler/scheduler_test.go` | æ·»åŠ å•å…ƒæµ‹è¯• | +75 |

### 2. æ–°å¢å­—æ®µ

```go
type Scheduler struct {
    // ...ç°æœ‰å­—æ®µ...

    // å¿ƒè·³ç›‘æ§ï¼ˆç”¨äºæ£€æµ‹ç³»ç»Ÿç¡çœ /å”¤é†’ï¼‰
    summaryResetCh chan struct{} // æ€»ç»“ä»»åŠ¡é‡ç½®é€šé“
    lastHeartbeat  time.Time     // ä¸Šæ¬¡å¿ƒè·³æ—¶é—´
    heartbeatMu    sync.Mutex    // å¿ƒè·³æ—¶é—´é”
}
```

### 3. æ–°å¢æ–¹æ³•

- `monitorHeartbeat()` - å¿ƒè·³ç›‘æ§ä¸»å¾ªç¯
- `handleWakeUp(duration)` - å¤„ç†å”¤é†’äº‹ä»¶

### 4. æ”¹è¿›æ–¹æ³•

- `runDailySummaryTask()` - æ·»åŠ äº† `summaryResetCh` ç›‘å¬ï¼Œæ”¯æŒå”¤é†’åé‡ç½®
- `Start()` - å¯åŠ¨å¿ƒè·³ç›‘æ§ goroutine

## éªŒè¯æ­¥éª¤

### æ­¥éª¤ 1ï¼šæŸ¥çœ‹å¿ƒè·³æ—¥å¿—

å¯åŠ¨æœåŠ¡åï¼ŒæŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¿ƒè·³ç›‘æ§å·²å¯åŠ¨ï¼š

```bash
# å¯åŠ¨æœåŠ¡
./daily_summary serve

# æŸ¥çœ‹æ—¥å¿—
tail -f run/logs/app.log
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
2026/01/21 11:31:34 Scheduler started
2026/01/21 11:31:34 Heartbeat monitor started (interval: 10s, threshold: 20s)
2026/01/21 11:31:34 Using minute-based scheduling: every 45 minute(s)
2026/01/21 11:31:34 Next reminder scheduled at 12:16:00
2026/01/21 11:31:34 Next summary generation at 2026-01-22 11:00:00
```

### æ­¥éª¤ 2ï¼šæµ‹è¯•ç¡çœ å”¤é†’

#### æ–¹æ³• Aï¼šçœŸå®ç¡çœ æµ‹è¯•ï¼ˆæ¨èï¼‰

1. **è®°å½•å½“å‰çŠ¶æ€**ï¼š
   ```bash
   tail -5 run/logs/app.log
   ```
   è®°å½•ä¸‹æ¬¡æé†’æ—¶é—´ï¼ˆå¦‚ 12:16:00ï¼‰

2. **è®© Mac è¿›å…¥ç¡çœ **ï¼š
   - é€‰é¡¹ 1ï¼šç›–ä¸Š MacBook ç›–å­
   - é€‰é¡¹ 2ï¼šèœå•æ  â†’ ç¡çœ 
   - é€‰é¡¹ 3ï¼šå¿«æ·é”® `âŒ˜ + Option + ç”µæºé”®`

3. **ç­‰å¾… 1-2 åˆ†é’Ÿ**ï¼ˆç¡®ä¿è¶…è¿‡ 20 ç§’é˜ˆå€¼ï¼‰

4. **å”¤é†’ Mac**ï¼š
   - æ‰“å¼€ç›–å­æˆ–æŒ‰ä»»æ„é”®

5. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   ```bash
   tail -20 run/logs/app.log
   ```

**é¢„æœŸç»“æœ**ï¼š
```
2026/01/21 11:35:00 Next reminder scheduled at 12:16:00
[Mac ç¡çœ  2 åˆ†é’Ÿ]
2026/01/21 11:37:15 === System wake-up detected! ===
2026/01/21 11:37:15 Last heartbeat: 2m15s ago (threshold: 20s)
2026/01/21 11:37:15 Handling system wake-up (sleep duration: 2m15s)...
2026/01/21 11:37:15 âœ“ Hourly task reset signal sent
2026/01/21 11:37:15 âœ“ Summary task reset signal sent
2026/01/21 11:37:15 === Wake-up handling completed ===
2026/01/21 11:37:15 Received reset signal, rescheduling next reminder
2026/01/21 11:37:15 Next reminder scheduled at 12:22:00  â† é‡æ–°è®¡ç®—ï¼
2026/01/21 11:37:15 Summary task received wake-up signal, recalculating...
2026/01/21 11:37:15 Next summary generation at 2026-01-22 11:00:00
```

#### æ–¹æ³• Bï¼šæ¨¡æ‹Ÿç¡çœ æµ‹è¯•ï¼ˆè°ƒè¯•ç”¨ï¼‰

ä½¿ç”¨ç³»ç»Ÿè°ƒè¯•å·¥å…·æš‚åœè¿›ç¨‹ï¼š

```bash
# 1. æŸ¥æ‰¾è¿›ç¨‹ PID
ps aux | grep daily_summary

# 2. æš‚åœè¿›ç¨‹ï¼ˆæ¨¡æ‹Ÿç¡çœ ï¼‰
kill -STOP <PID>

# 3. ç­‰å¾… 30 ç§’

# 4. æ¢å¤è¿›ç¨‹ï¼ˆæ¨¡æ‹Ÿå”¤é†’ï¼‰
kill -CONT <PID>

# 5. æŸ¥çœ‹æ—¥å¿—
tail -20 run/logs/app.log
```

**æ³¨æ„**ï¼šæ­¤æ–¹æ³•å¯èƒ½ä¸ä¼šè§¦å‘å”¤é†’æ£€æµ‹ï¼Œå› ä¸ºè¿›ç¨‹å®Œå…¨æš‚åœæ—¶å¿ƒè·³ä¹Ÿæš‚åœã€‚

### æ­¥éª¤ 3ï¼šéªŒè¯å®šæ—¶å™¨é‡ç½®

å”¤é†’åï¼Œç¡®è®¤ä»¥ä¸‹è¡Œä¸ºï¼š

1. **Hourly Task å·²é‡ç½®**ï¼š
   - ä¸‹æ¬¡æé†’æ—¶é—´ä»å½“å‰æ—¶é—´é‡æ–°è®¡ç®—
   - ç¤ºä¾‹ï¼šå”¤é†’æ—¶é—´ 11:37ï¼Œä¸‹æ¬¡æé†’ 12:22ï¼ˆ45 åˆ†é’Ÿåï¼‰

2. **Summary Task å·²é‡ç½®**ï¼š
   - å¦‚æœåœ¨æ€»ç»“æ—¶é—´å‰å”¤é†’ï¼Œä¿æŒåŸæ—¶é—´
   - å¦‚æœåœ¨æ€»ç»“æ—¶é—´åå”¤é†’ä¸”æœªç”Ÿæˆï¼Œç«‹å³ç”Ÿæˆ

3. **æ— é‡å¤æé†’**ï¼š
   - ç¡çœ æœŸé—´é”™è¿‡çš„æé†’ä¸ä¼šè¡¥å¿ï¼ˆæŒ‰è®¾è®¡è·³è¿‡ï¼‰

### æ­¥éª¤ 4ï¼šé•¿æ—¶é—´ç¡çœ æµ‹è¯•

æµ‹è¯•ç¡çœ è¶…è¿‡ 1 å°æ—¶çš„åœºæ™¯ï¼š

```bash
# 1. è®°å½•å½“å‰æ—¶é—´å’Œä¸‹æ¬¡æé†’æ—¶é—´

# 2. Mac ç¡çœ  1-2 å°æ—¶

# 3. å”¤é†’åæŸ¥çœ‹æ—¥å¿—
```

**é¢„æœŸæ—¥å¿—**ï¼ˆé¢å¤–æç¤ºï¼‰ï¼š
```
2026/01/21 13:30:00 === System wake-up detected! ===
2026/01/21 13:30:00 Last heartbeat: 1h25m ago (threshold: 20s)
2026/01/21 13:30:00 Handling system wake-up (sleep duration: 1h25m)...
2026/01/21 13:30:00 âœ“ Hourly task reset signal sent
2026/01/21 13:30:00 âœ“ Summary task reset signal sent
2026/01/21 13:30:00 Long sleep detected (1h25m), timers have been reset  â† é•¿ç¡çœ æç¤º
2026/01/21 13:30:00 === Wake-up handling completed ===
```

## å•å…ƒæµ‹è¯•

è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼š

```bash
go test ./internal/scheduler/ -v
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
1. `TestHeartbeatMonitor` - æµ‹è¯•å¿ƒè·³ç›‘æ§å’Œå”¤é†’æ£€æµ‹
2. `TestWakeUpHandler` - æµ‹è¯•å”¤é†’å¤„ç†é€»è¾‘
3. `TestSummaryResetChannel` - æµ‹è¯•æ€»ç»“ä»»åŠ¡é‡ç½®é€šé“

**é¢„æœŸè¾“å‡º**ï¼š
```
=== RUN   TestHeartbeatMonitor
--- PASS: TestHeartbeatMonitor (0.00s)
=== RUN   TestWakeUpHandler
--- PASS: TestWakeUpHandler (0.00s)
=== RUN   TestSummaryResetChannel
--- PASS: TestSummaryResetChannel (0.00s)
PASS
ok  	humg.top/daily_summary/internal/scheduler	0.382s
```

## å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆæ²¡æœ‰æ£€æµ‹åˆ°å”¤é†’ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. ç¡çœ æ—¶é—´å¤ªçŸ­ï¼ˆ< 20 ç§’ï¼‰
2. è¿›ç¨‹è¢«å®Œå…¨æš‚åœï¼ˆå¦‚ kill -STOPï¼‰
3. æœåŠ¡æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ç¡çœ è‡³å°‘ 30 ç§’
- ä½¿ç”¨çœŸå®çš„ Mac ç¡çœ è€Œéè¿›ç¨‹æš‚åœ
- æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š`ps aux | grep daily_summary`

### Q2ï¼šä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šè¯¯åˆ¤å”¤é†’ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. ç³»ç»Ÿé«˜è´Ÿè½½å¯¼è‡´å¿ƒè·³å»¶è¿Ÿ
2. NTP æ—¶é—´åŒæ­¥å¯¼è‡´æ—¶é—´è·³å˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å½“å‰é˜ˆå€¼ 20 ç§’å·²ç»æ¯”è¾ƒåˆç†
- å¦‚æœé¢‘ç¹è¯¯åˆ¤ï¼Œå¯ä»¥è°ƒæ•´é˜ˆå€¼ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰

### Q3ï¼šå¦‚ä½•è°ƒæ•´å¿ƒè·³é—´éš”å’Œé˜ˆå€¼ï¼Ÿ

å½“å‰ç¡¬ç¼–ç åœ¨ `monitorHeartbeat()` æ–¹æ³•ä¸­ï¼š

```go
ticker := time.NewTicker(10 * time.Second) // å¿ƒè·³é—´éš”
if elapsed > 20*time.Second {              // å”¤é†’é˜ˆå€¼
```

**æœªæ¥æ”¹è¿›**ï¼šå¯ä»¥æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ï¼š
```yaml
heartbeat_interval: 10  # ç§’
wake_threshold: 20      # ç§’
```

## ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | serve (æ—§) | tick (launchd) | å¿ƒè·³å”¤é†’ (æ–°) |
|-----|-----------|----------------|--------------|
| ç¡çœ å…¼å®¹æ€§ | âŒ timer å¤±æ•ˆ | âœ… ç³»ç»Ÿè°ƒåº¦ | âœ… ä¸»åŠ¨æ£€æµ‹ |
| æ™ºèƒ½é‡ç½® | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| èµ„æºå ç”¨ | ä¸­ | ä½ | ä¸­+ |
| å®ç°å¤æ‚åº¦ | ä½ | ä¸­ | ä½ |
| è·¨å¹³å° | âœ… | âŒ macOS | âœ… |

**æ¨èä½¿ç”¨åœºæ™¯**ï¼š
- éœ€è¦æ™ºèƒ½é‡ç½®ï¼ˆæ‰‹åŠ¨ add åé¡ºå»¶ï¼‰â†’ å¿ƒè·³å”¤é†’ â­
- åªéœ€å®šæ—¶æé†’ï¼Œè¿½æ±‚æœ€ä½èµ„æºå ç”¨ â†’ tick (launchd)
- æµ‹è¯•ç¯å¢ƒæˆ–å…¶ä»–å¹³å° â†’ serve (æ—§)

## æŠ€æœ¯ç»†èŠ‚

### å¿ƒè·³ç›‘æ§å¾ªç¯

```go
func (s *Scheduler) monitorHeartbeat() {
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()

    for {
        select {
        case now := <-ticker.C:
            s.heartbeatMu.Lock()
            elapsed := now.Sub(s.lastHeartbeat)  // è®¡ç®—é—´éš”
            s.lastHeartbeat = now                // æ›´æ–°æ—¶é—´
            s.heartbeatMu.Unlock()

            if elapsed > 20*time.Second {        // æ£€æµ‹é˜ˆå€¼
                s.handleWakeUp(elapsed)          // è§¦å‘å¤„ç†
            }

        case <-s.stopCh:
            return
        }
    }
}
```

### å”¤é†’å¤„ç†æµç¨‹

```go
func (s *Scheduler) handleWakeUp(sleepDuration time.Duration) {
    // 1. è®°å½•æ—¥å¿—
    log.Printf("System wake-up detected! Sleep: %s", sleepDuration)

    // 2. å‘é€é‡ç½®ä¿¡å·ç»™ hourly task
    s.resetCh <- struct{}{}

    // 3. å‘é€é‡ç½®ä¿¡å·ç»™ summary task
    s.summaryResetCh <- struct{}{}

    // 4. é•¿ç¡çœ ç‰¹æ®Šæç¤º
    if sleepDuration > time.Hour {
        log.Printf("Long sleep detected")
    }
}
```

### runDailySummaryTask æ”¹è¿›

**Before**ï¼š
```go
select {
case <-time.After(waitDuration):
    s.generateSummary()
case <-s.stopCh:
    return
}
```

**After**ï¼š
```go
select {
case <-time.After(waitDuration):
    s.generateSummary()

case <-s.summaryResetCh:  // æ–°å¢
    // é‡æ–°è®¡ç®—ä¸‹ä¸€æ¬¡æ—¶é—´
    continue

case <-s.stopCh:
    return
}
```

## æ€»ç»“

âœ… **å®æ–½å®Œæˆ**ï¼š
- å¿ƒè·³ç›‘æ§æœºåˆ¶å·²å®ç°
- å”¤é†’æ£€æµ‹å’Œè‡ªåŠ¨é‡ç½®å·²å®ç°
- å•å…ƒæµ‹è¯•å·²é€šè¿‡
- ç¼–è¯‘æµ‹è¯•æˆåŠŸ

ğŸ¯ **ä¸‹ä¸€æ­¥**ï¼š
1. è¿è¡ŒçœŸå®ç¡çœ æµ‹è¯•éªŒè¯åŠŸèƒ½
2. è§‚å¯Ÿå‡ å¤©ç¡®ä¿ç¨³å®šæ€§
3. æ ¹æ®éœ€è¦è°ƒæ•´å¿ƒè·³é—´éš”å’Œé˜ˆå€¼
4. å¯é€‰ï¼šæ·»åŠ é…ç½®æ–‡ä»¶æ”¯æŒï¼ˆPhase 2ï¼‰

ğŸ“ **è®°å½•ä½ çš„æµ‹è¯•ç»“æœ**ï¼š
- æµ‹è¯•æ—¶é—´ï¼š
- ç¡çœ æ—¶é•¿ï¼š
- æ˜¯å¦æ£€æµ‹åˆ°å”¤é†’ï¼š
- å®šæ—¶å™¨æ˜¯å¦é‡ç½®ï¼š
- å…¶ä»–è§‚å¯Ÿï¼š
