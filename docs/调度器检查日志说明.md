# 调度器检查日志说明

## 日志文件位置

调度器检查日志保存在：`run/logs/scheduler_check.log`

## 日志格式

每分钟的检查周期都会完整记录，包括每个任务的检查状态。

### 日志标签

- `[CHECK]` - 检查周期的开始和结束
- `[SKIP]` - 任务被跳过（包含跳过原因）
- `[EXECUTE]` - 任务执行相关
- `[ERROR]` - 错误信息

## 日志示例

### 示例 1：正常检查，无任务执行

```
2026/01/23 12:00:00 [CHECK] Starting task check at 2026-01-23 12:00:00
2026/01/23 12:00:00 [SKIP] Task work-reminder (工作记录提醒): not yet time (NextRun: 2026-01-23 12:30:00)
2026/01/23 12:00:00 [SKIP] Task daily-summary (每日总结生成): not yet time (NextRun: 2026-01-24 00:00:00)
2026/01/23 12:00:00 [CHECK] Task check completed at 2026-01-23 12:00:00

```

### 示例 2：任务执行

```
2026/01/23 12:30:00 [CHECK] Starting task check at 2026-01-23 12:30:00
2026/01/23 12:30:00 [EXECUTE] Task work-reminder (工作记录提醒): starting execution
2026/01/23 12:31:15 [EXECUTE] Task work-reminder (工作记录提醒): execution completed successfully
2026/01/23 12:30:00 [SKIP] Task daily-summary (每日总结生成): not yet time (NextRun: 2026-01-24 00:00:00)
2026/01/23 12:30:00 [CHECK] Task check completed at 2026-01-23 12:30:00

```

### 示例 3：任务正在执行时被跳过（防止重复触发）

```
2026/01/23 12:30:00 [CHECK] Starting task check at 2026-01-23 12:30:00
2026/01/23 12:30:00 [EXECUTE] Task work-reminder (工作记录提醒): starting execution
2026/01/23 12:30:00 [SKIP] Task daily-summary (每日总结生成): not yet time (NextRun: 2026-01-24 00:00:00)
2026/01/23 12:30:00 [CHECK] Task check completed at 2026-01-23 12:30:00

2026/01/23 12:31:00 [CHECK] Starting task check at 2026-01-23 12:31:00
2026/01/23 12:31:00 [SKIP] Task work-reminder (工作记录提醒): already running
2026/01/23 12:31:00 [SKIP] Task daily-summary (每日总结生成): not yet time (NextRun: 2026-01-24 00:00:00)
2026/01/23 12:31:00 [CHECK] Task check completed at 2026-01-23 12:31:00

2026/01/23 12:32:15 [EXECUTE] Task work-reminder (工作记录提醒): execution completed successfully
```

### 示例 4：任务被禁用

```
2026/01/23 12:00:00 [CHECK] Starting task check at 2026-01-23 12:00:00
2026/01/23 12:00:00 [SKIP] Task work-reminder (工作记录提醒): disabled
2026/01/23 12:00:00 [SKIP] Task daily-summary (每日总结生成): not yet time (NextRun: 2026-01-24 00:00:00)
2026/01/23 12:00:00 [CHECK] Task check completed at 2026-01-23 12:00:00

```

### 示例 5：任务执行失败

```
2026/01/23 12:30:00 [CHECK] Starting task check at 2026-01-23 12:30:00
2026/01/23 12:30:00 [EXECUTE] Task work-reminder (工作记录提醒): starting execution
2026/01/23 12:30:15 [EXECUTE] Task work-reminder (工作记录提醒): execution failed - failed to show dialog: timeout
2026/01/23 12:30:00 [SKIP] Task daily-summary (每日总结生成): not yet time (NextRun: 2026-01-24 00:00:00)
2026/01/23 12:30:00 [CHECK] Task check completed at 2026-01-23 12:30:00

```

## 跳过原因说明

| 跳过原因 | 说明 |
|---------|------|
| `disabled` | 任务被禁用（enabled = false） |
| `not yet time (NextRun: ...)` | 尚未到达预定的执行时间 |
| `ShouldRun() returned false` | 任务的业务逻辑判断不应执行（如：今天已生成总结） |
| `already running` | 任务正在执行中，防止重复触发 |

## 调试建议

### 1. 查看最近的检查记录
```bash
tail -50 run/logs/scheduler_check.log
```

### 2. 查看特定任务的日志
```bash
grep "work-reminder" run/logs/scheduler_check.log
```

### 3. 查看执行记录
```bash
grep "\[EXECUTE\]" run/logs/scheduler_check.log
```

### 4. 查看跳过记录
```bash
grep "\[SKIP\]" run/logs/scheduler_check.log
```

### 5. 查看错误记录
```bash
grep "\[ERROR\]" run/logs/scheduler_check.log
```

### 6. 实时监控调度器
```bash
tail -f run/logs/scheduler_check.log
```

## 日志文件管理

### 自动轮转

调度检查日志支持自动轮转，与主应用日志共用同一个配置参数 `max_log_size_mb`。

#### 配置示例

```yaml
# config.yaml
# 此配置同时应用于主应用日志和调度器检查日志
max_log_size_mb: 10  # 当日志文件超过 10MB 时自动轮转
```

#### 轮转机制

1. **触发时机**：服务启动时检查日志文件大小
2. **轮转操作**：
   - 如果日志文件大小超过配置的限制，将当前文件重命名为 `scheduler_check.log.old`
   - 如果 `.old` 文件已存在，先删除旧的备份
   - 创建新的空日志文件
3. **日志记录**：轮转操作会在主应用日志中记录

#### 轮转日志示例

```
2026/01/23 12:00:00 Scheduler check log file rotated: run/logs/scheduler_check.log (12.50 MB) -> run/logs/scheduler_check.log.old
```

### 日志文件列表

- `scheduler_check.log` - 当前活跃的日志文件
- `scheduler_check.log.old` - 上一次轮转的备份文件

### 估算日志大小

假设：
- 每分钟 4 行日志（开始、2个任务检查、结束）
- 每行约 120 字节
- 每分钟约 480 字节

| 时间跨度 | 日志大小（约） |
|---------|--------------|
| 1 小时  | 28 KB        |
| 1 天    | 675 KB       |
| 1 周    | 4.6 MB       |
| 1 月    | 20 MB        |
| 2 月    | 40 MB        |

**建议**：设置 `max_scheduler_log_size_mb: 10` 可以保留约 2 周的详细检查记录。

## 与主日志的区别

| 特性 | 主日志 (app.log) | 调度检查日志 (scheduler_check.log) |
|------|-----------------|-----------------------------------|
| 内容 | 应用整体日志 | 仅调度器检查日志 |
| 频率 | 按事件记录 | 每分钟固定记录 |
| 详细程度 | 关键事件 | 每次检查的完整细节 |
| 用途 | 应用运行监控 | 调度行为分析和调试 |

## 注意事项

1. **日志文件会持续增长**：每分钟至少记录 3-4 行（开始、各任务检查、结束）
2. **适合调试**：通过检查日志可以清楚了解为什么某个任务没有执行
3. **性能影响小**：文件 I/O 采用追加模式，对性能影响很小
4. **独立文件**：与主应用日志分离，便于单独分析调度问题
